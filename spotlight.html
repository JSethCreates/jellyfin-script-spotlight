<html>
<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Spotlight - A Jellyfin UI Enhancement v2.7.2</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        .slide { position: relative; width: 100vw; height: 100vh; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); cursor: pointer; }
        .backdrop { position: absolute; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); object-fit: cover; object-position: center 25%; border-radius: 5px; z-index: 1; transition: width 0.5s ease; }
        .logo { position: absolute; top: 55%; left: 23%; transform: translateY(-50%) translateX(-50%) !important; max-height: 50%; max-width: 30%; width: auto; z-index: 5; transition: top 0.5s ease, transform 2.5s ease; text-shadow: -2px 2px 4px rgba(0, 0, 0, 0.5); filter: drop-shadow(1px 1px 1px); }
        .heading { position: absolute; top: 0; left: 0; width: 100%; height: 50px; background-color: transparent; font-family: "Titillium Web", sans-serif; color: #D3D3D3; font-size: 22px; display: flex; align-items: center; justify-content: flex-start; z-index: 2; padding: 10px; box-sizing: border-box; }
        .video-container { position: absolute; right: 0; top: 50px; width: 0; height: calc(100% - 50px); overflow: hidden; z-index: 0; transition: width 0.5s ease; }
        .video-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .clickable-overlay { position: absolute; top: 50px; left: 0; width: calc(100% - 50px); height: calc(100% - 50px); z-index: 7; cursor: pointer; background: linear-gradient(140deg, rgba(0, 0, 0, 0.89) 0%, rgba(0, 0, 0, 0.69) 6.25%, rgba(0, 0, 0, 0.52) 12.5%, rgba(0, 0, 0, 0.39) 18.75%, rgba(0, 0, 0, 0.28) 25%, rgba(0, 0, 0, 0.2) 31.25%, rgba(0, 0, 0, 0.14) 37.5%, rgba(0, 0, 0, 0.09) 43.75%, rgba(0, 0, 0, 0.05) 50%, rgba(0, 0, 0, 0.03) 56.25%, rgba(0, 0, 0, 0.02) 62.5%, rgba(0, 0, 0, 0.01) 68.75%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0) 81.25%, rgba(0, 0, 0, 0) 87.5%, rgba(0, 0, 0, 0) 93.75%, rgba(0, 0, 0, 0) 100%); }
        .lorem-ipsum { position: absolute; top: 2.0em; width: 100%; text-align: right; font-family: "Titillium Web", sans-serif; font-size: 1.4em; text-shadow: 2px 2px 20px rgba(0, 0, 0, 1); opacity: 0; transition: opacity 0.3s ease, width 0.5s ease; color: #ecf0f1; z-index: 4; box-sizing: border-box; line-height: 1.75em; padding-right: 10px; }
        .plot { position: absolute; bottom: 0; left: 0; right: 0; color: white; font-family: "Titillium Web", sans-serif; font-size: 1.1em; font-style: italic; background: linear-gradient(0deg, rgb(0% 0% 0% / 0.86) 0%, rgb(0% 0% 0% / 0.8566406249999999) 6.25%, rgb(0% 0% 0% / 0.8465625) 12.5%, rgb(0% 0% 0% / 0.829765625) 18.75%, rgb(0% 0% 0% / 0.80625) 25%, rgb(0% 0% 0% / 0.776015625) 31.25%, rgb(0% 0% 0% / 0.7390625) 37.5%, rgb(0% 0% 0% / 0.6953906249999999) 43.75%, rgb(0% 0% 0% / 0.645) 50%, rgb(0% 0% 0% / 0.587890625) 56.25%, rgb(0% 0% 0% / 0.5240625) 62.5%, rgb(0% 0% 0% / 0.453515625) 68.75%, rgb(0% 0% 0% / 0.37625) 75%, rgb(0% 0% 0% / 0.292265625) 81.25%, rgb(0% 0% 0% / 0.20156249999999998) 87.5%, rgb(0% 0% 0% / 0.10414062499999999) 93.75%, rgb(0% 0% 0% / 0) 100%); padding: 10px; border-radius: 0.2em; z-index: 4; box-sizing: border-box; transition: width 0.5s ease; padding-bottom: 3px; padding-top: 0.5em; line-height: 1.3em; text-shadow: 1px 1px 4px rgba(0, 0, 0, 1); mask-image: linear-gradient(to right, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0) 100%); -webkit-mask-image: linear-gradient(to right, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0) 100%); }
        .slide:hover .logo { transform: translateY(-50%) translateX(-50%) scale(1.35) !important; }
        .slide:hover .lorem-ipsum { opacity: 1; }
        .star-icon { color: gold; font-size: 1em; margin-right: 0em; }
        .emby-scrollbuttons { position: absolute; top: 0; right: 0; display: flex; z-index: 2; }
        .emby-scrollbuttons-button { background: none; border: none; color: #D3D3D3; font-size: 1.4em; cursor: pointer; padding: 6px; }
        .emby-scrollbuttons-button:disabled { opacity: 0.5; cursor: default; }
        .material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: inherit; display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal; word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; -moz-osx-font-smoothing: grayscale; font-feature-settings: 'liga'; }
    </style>
</head>
<body>
    <div id="slides-container"></div>
    <div class="heading" id="titleHeading">Spotlight</div>
    <div class="emby-scrollbuttons">
        <button id="leftButton" class="emby-scrollbuttons-button paper-icon-button-light" type="button"
            disabled tabindex="0">
            <span class="material-icons chevron_left" aria-hidden="true">chevron_left</span>
        </button>
        <button id="rightButton" class="emby-scrollbuttons-button paper-icon-button-light" type="button"
            tabindex="0">
            <span class="material-icons chevron_right" aria-hidden="true">chevron_right</span>
        </button>
    </div>
    <script>
        if (window.spotlightScriptInitialized) {
            console.log("Spotlight script is already initialized, cleaning up before re-initialization.");
            shutdown();
        }

        window.spotlightScriptInitialized = true;

        let moviesSeriesBoth = 3, shuffleInterval = 10000, plotMaxLength = 220, token = 'de81a85d55024d7b9fa7b11031de7539', useTrailers = true;
        let isChangingSlide = false, player = null, slideChangeTimeout = null, isHomePageActive = false, navigationInterval = null;
        let currentLocation = window.top.location.href;
        let movieList = [], currentMovieIndex = 0, lastMovie = null, currentMovie = null;
        let customTitle = 'Spotlight';

        const createElem = (tag, className, textContent, src, alt) => {
            const elem = document.createElement(tag);
            if (className) elem.className = className;
            if (textContent) elem.textContent = textContent;
            if (src) elem.src = src;
            if (alt) elem.alt = alt;
            return elem;
        };

        const truncateText = (text, maxLength) => text && text.length > maxLength ? text.substr(0, maxLength) + '...' : text;

        const cleanup = () => {
            if (player && typeof player.stopVideo === 'function') {
                player.stopVideo();
                player.destroy();
                player = null;
            }
            clearTimeout(slideChangeTimeout);
            const container = document.getElementById('slides-container');
            if (container) container.innerHTML = '';
        };

        const shutdown = () => {
            clearTimeout(slideChangeTimeout);
            slideChangeTimeout = null;

            if (player && typeof player.stopVideo === 'function') {
                player.stopVideo();
                player.destroy();
                player = null;
            }

            const rightButton = document.getElementById('rightButton');
            const leftButton = document.getElementById('leftButton');
            if (rightButton) rightButton.onclick = null;
            if (leftButton) leftButton.onclick = null;

            const container = document.getElementById('slides-container');
            if (container) {
                container.innerHTML = '';
            }

            currentMovie = null;
            lastMovie = null;
            currentMovieIndex = 0;
            movieList = [];

            isHomePageActive = false;
            isChangingSlide = false;

            window.spotlightScriptInitialized = false;

            console.log("Slideshow has been completely shutdown");
        };

        const updateSlideButtons = () => {
            const leftButton = document.getElementById('leftButton');
            leftButton.disabled = !lastMovie || lastMovie.Id === currentMovie.Id;
        };

        const checkBackdropAndLogo = movie => {
            Promise.all(['/Images/Backdrop/0', '/Images/Logo'].map(url =>
                fetch(`/Items/${movie.Id}${url}`, { method: 'HEAD' }).then(response => response.ok)
            )).then(([backdropExists, logoExists]) =>
                backdropExists && logoExists ? createSlideElement(movie, true) : fetchNextMovie()
            ).catch(() => fetchNextMovie());
        };

        const createSlideElement = async (movie, hasVideo = false) => {
            cleanup();
            const container = document.getElementById('slides-container');
            const slide = createElem('div', 'slide');
            slide.appendChild(createElem('img', 'backdrop', null, `/Items/${movie.Id}/Images/Backdrop/0`, 'backdrop'));
            slide.appendChild(createElem('img', 'logo', null, `/Items/${movie.Id}/Images/Logo`, 'logo'));

            const textContainer = createElem('div', 'text-container');
            const premiereYear = movie.PremiereDate ? new Date(movie.PremiereDate).getFullYear() : 'Unknown';
            const additionalInfo = movie.Type === 'Series' ? (movie.ChildCount ? `${movie.ChildCount} Season${movie.ChildCount > 1 ? 's' : ''}` : 'Unknown Seasons') : (movie.RunTimeTicks ? `${Math.round(movie.RunTimeTicks / 600000000)} min` : 'Unknown Runtime');

            let loremText = `${premiereYear}   |   ${additionalInfo}`;
            if (movie.CommunityRating) loremText += `   |   <i class=\"star-icon fas fa-star\"></i> ${movie.CommunityRating.toFixed(1)}`;
            if (movie.CriticRating) loremText += `<img src="https://i.imgur.com/iMfwDk7.png" alt="Rotten Tomatoes" style="width: 1.2em; height: 1.2em; padding-left: 0.5em; vertical-align: sub;"> ${movie.CriticRating}%`;
            const loremDiv = createElem('div', 'lorem-ipsum');
            loremDiv.innerHTML = loremText;

            textContainer.appendChild(loremDiv);
            textContainer.appendChild(createElem('div', 'plot', truncateText(movie.Overview, plotMaxLength)));
            slide.appendChild(textContainer);

            const overlay = createElem('div', 'clickable-overlay', null, null, 'Movie Details');
            overlay.onclick = () => window.top.Emby.Page.showItem(movie.Id);
            overlay.setAttribute('tabindex', '0');
            slide.appendChild(overlay);

            if (useTrailers && movie.RemoteTrailers?.length > 0) {
                const videoId = new URL(movie.RemoteTrailers[0].Url).searchParams.get('v');
                let aspectRatio = 16 / 9;
                try {
                    const response = await fetch('https://noembed.com/embed?url=https://www.youtube.com/watch?v=' + videoId);
                    const data = await response.json();
                    if (data.width && data.height) aspectRatio = data.width / data.height;
                } catch (e) { }

                const videoContainer = createElem('div', 'video-container', null, null, 'Play Trailer');
                const videoElement = createElem('div', 'video-player');
                videoContainer.appendChild(videoElement);
                videoContainer.setAttribute('tabindex', '0');
                slide.appendChild(videoContainer);

                player = new YT.Player(videoElement, {
                    height: '100%', width: '100%', videoId: videoId,
                    playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 0, 'rel': 0, 'modestbranding': 1, 'color': 'white', 'iv_load_policy': 3, 'fs': 0 },
                    events: {
                        'onReady': event => {
                            event.target.playVideo();
                            event.target.setVolume(50);
                            const videoContainerHeight = videoContainer.clientHeight;
                            const calculatedWidth = videoContainerHeight * aspectRatio;
                            videoContainer.style.width = `${calculatedWidth}px`;

                            const backdropElement = document.querySelector('.backdrop');
                            if (backdropElement) {
                                backdropElement.style.width = `calc(100% - ${calculatedWidth * 0.6}px)`;
                                backdropElement.style.webkitMaskImage = backdropElement.style.maskImage = `linear-gradient(to right, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 1) ${calculatedWidth}px, rgba(255, 255, 255, 0) 100%)`;
                                backdropElement.style.backgroundImage = `url(/Items/${movie.Id}/Images/Backdrop/0)`;
                                backdropElement.style.backgroundSize = 'cover';
                                backdropElement.style.backgroundPosition = 'center';
                            }

                            const videoElement = document.querySelector('.video-player');
                            if (videoElement) {
                                videoElement.style.webkitMaskImage = videoElement.style.maskImage = `linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 25%)`;
                            }

                            ['plot', 'lorem-ipsum', 'clickable-overlay'].forEach(cls => {
                                const element = document.querySelector(`.${cls}`);
                                if (element) element.style.width = `calc(100% - ${calculatedWidth}px)`;
                            });
                        },
                        'onStateChange': event => {
                            if (event.data === YT.PlayerState.ENDED) setTimeout(fetchNextMovie, 100);
                        },
                        'onError': () => {
                            if (player) {
                                player.destroy();
                                player = null;
                            }

                            ['backdrop', 'plot', 'lorem-ipsum'].forEach(cls => {
                                const element = document.querySelector(`.${cls}`);
                                if (element) element.style.width = '100%';
                            });
                            videoContainer.style.width = '0';
                            startSlideChangeTimer();
                        }
                    }
                });
            } else startSlideChangeTimer();

            container.innerHTML = '';
            container.appendChild(slide);

            currentMovie = movie;
            updateSlideButtons();
        };

        const readCustomList = () =>
            fetch('list.txt?' + new Date().getTime())
                .then(response => response.ok ? response.text() : null)
                .then(text => {
                    if (!text) return null;
                    const lines = text.split('\n').filter(Boolean);
                    customTitle = lines.shift() || customTitle;
                    document.getElementById('titleHeading').textContent = customTitle;
                    return lines.map(line => line.trim().substring(0, 32));
                })
                .catch(() => null);

        const fetchRandomMovie = () => {
            if (isChangingSlide) return;
            isChangingSlide = true;

            if (movieList.length === 0) {
                readCustomList().then(list => {
                    if (list) {
                        movieList = list;
                        currentMovieIndex = 0;
                    }
                    fetchNextMovie();
                });
            } else fetchNextMovie();
        };

        const fetchNextMovie = () => {
            if (currentMovie) lastMovie = currentMovie;

            const fetchCurrentUserId = () => fetch('/Sessions', {
                headers: { 'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"` }
            })
                .then(response => response.json())
                .then(sessions => {
                    const currentSession = sessions.find(session => session.UserId);
                    return currentSession ? currentSession.UserId : null;
                })
                .catch(() => null);

            fetchCurrentUserId().then(currentUserId => {
                if (!currentUserId) return;

                const headers = { 'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"` };

                if (movieList.length > 0) {
                    if (currentMovieIndex >= movieList.length) currentMovieIndex = 0;
                    const movieId = movieList[currentMovieIndex];
                    currentMovieIndex++;

                    fetch(`/Users/${currentUserId}/Items/${movieId}?Fields=Overview,RemoteTrailers,PremiereDate,RunTimeTicks,ChildCount`, { headers })
                        .then(response => response.json())
                        .then(movie => {
                            checkBackdropAndLogo(movie);
                        })
                        .catch(() => startSlideChangeTimer())
                        .finally(() => { isChangingSlide = false; });
                } else {
                    const itemTypes = moviesSeriesBoth === 1 ? 'Movie' : (moviesSeriesBoth === 2 ? 'Series' : 'Movie,Series');
                    fetch(`/Users/${currentUserId}/Items?IncludeItemTypes=${itemTypes}&Recursive=true&Limit=1&SortBy=random&Fields=Id,Overview,RemoteTrailers,PremiereDate,RunTimeTicks,ChildCount`, { headers })
                        .then(response => response.json())
                        .then(data => {
                            if (data.Items[0]) {
                                checkBackdropAndLogo(data.Items[0]);
                            }
                        })
                        .catch(() => startSlideChangeTimer())
                        .finally(() => { isChangingSlide = false; });
                }
            });
        };

        const startSlideChangeTimer = () => {
            clearTimeout(slideChangeTimeout);
            slideChangeTimeout = setTimeout(fetchNextMovie, shuffleInterval);
        };

        const checkNavigation = () => {
            const newLocation = window.top.location.href;
            if (newLocation !== currentLocation) {
                currentLocation = newLocation;
                const isHomePage = url => url.includes('/home') || url.endsWith('/web/') || url.endsWith('/web/index.html');
                if (isHomePage(newLocation)) {
                    if (!isHomePageActive) {
                        console.log("Now on homepage, starting slideshow");
                        isHomePageActive = true;
                        cleanup();
                        fetchRandomMovie();
                    }
                } else if (isHomePageActive) {
                    console.log("No longer on homepage, shutting down slideshow");
                    isHomePageActive = false;
                    shutdown();
                }
            } else {
                const isHomePage = url => url.includes('/home') || url.endsWith('/web/') || url.endsWith('/web/index.html');
                if (isHomePage(newLocation) && !isHomePageActive) {
                    console.log("Detected back navigation to homepage, starting slideshow");
                    isHomePageActive = true;
                    cleanup();
                    fetchRandomMovie();
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (window.innerWidth < 1001) useTrailers = false;
            checkNavigation();
            if (!navigationInterval) {
                navigationInterval = setInterval(checkNavigation, 250);
            }
        });

        document.getElementById('rightButton').onclick = fetchNextMovie;
        document.getElementById('leftButton').onclick = () => {
            if (lastMovie) {
                createSlideElement(lastMovie, true);
            }
        };
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
