<!DOCTYPE html>
<html>
<script>
    // Configuration variables
    let defaultTitle = 'Spotlight'; // Default title, overridden by list.txt if available
    const shuffleInterval = 10000; // Time in milliseconds between slide changes
    const plotMaxLength = 240; // Maximum length of the plot text
    const numberOfMovies = 20; // Number of movies to fetch each time homescreen is called
    const randomStartMax = 1000; // Maximum value for random start index, make this roughly lower than your total number movies+series
    const includeRemoteTrailers = false; // Set to true to include remote trailers in addition to local trailers
    const UseAnyTrailers = true; // Set to false to disable trailer box completely

    const userId = '0e0755005f074a59bc0108cc2c3e650b'; // Replace with your User ID
    const token = 'de81a85d55024d7b9fa7b11031de7539'; // Replace with your API token
    const listFileName = 'list.txt'; // Name of the file containing the list of movie IDs, if no file exists, we will select numberOfMovies at random
</script>

<head>
    <title>Spotlight: Jellyfin Featured Slideshow</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
    <style>
        /* CSS styles remain the same */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .slide {
            position: relative;
            width: 100vw;
            height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            outline: none;
        }
        .slide:focus {
            outline: 2px solid #fff;
        }
        .backdrop {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            height: calc(100% - 50px);
            object-fit: cover;
            object-position: center 20%;
            border-radius: 5px;
            z-index: 1;
        }
        .logo {
            position: absolute;
            top: 65%;
            left: 10px;
            transform: translateY(-50%);
            max-height: 50%;
            max-width: 30%;
            width: auto;
            z-index: 3;
        }
        .featured-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: transparent;
            font-family: 'Noto Sans', sans-serif;
            color: #D3D3D3;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            z-index: 2;
        }
        .plot {
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
            color: white;
            width: 100%;
            font-family: 'Noto Sans', sans-serif;
            font-size: 15px;
            background: linear-gradient(to top, rgba(0, 0, 0, 1) 20%, rgba(0, 0, 0, 0) 100%);
            padding: 10px;
            border-radius: 5px;
            z-index: 4;
            box-sizing: border-box;
        }
        .wide-screen-content {
            position: absolute;
            top: 0;
            right: 0;
            width: 550px;
            height: 100%;
            background-color: black;
            z-index: 5;
            display: none;
        }
        .trailer-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .slide.with-wide-content .backdrop,
        .slide.with-wide-content .logo,
        .slide.with-wide-content .featured-content,
        .slide.with-wide-content .plot {
            width: calc(100% - 550px);
        }
        @media (max-width: 1200px) {
            .wide-screen-content {
                display: none !important;
            }
            .slide.with-wide-content .backdrop,
            .slide.with-wide-content .logo,
            .slide.with-wide-content .featured-content,
            .slide.with-wide-content .plot {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- Container for dynamic slides -->
<div id="slides-container"></div>

<!-- JavaScript for fetching movies and creating the slideshow -->
<script>
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function truncateText(element, maxLength) {
        var truncated = element.innerText;

        if (truncated.length > maxLength) {
            truncated = truncated.substr(0, maxLength) + '...';
        }
        element.innerText = truncated;
    }

    function createSlideForMovie(movie, title) {
        const container = document.getElementById('slides-container');
        const slideElement = createSlideElement(movie, title);
        container.appendChild(slideElement);
    }

    function createSlideElement(movie, title) {
        const itemId = movie.Id;
        const plot = movie.Overview;
        const hasTrailer = movie.hasTrailer;
        const trailerId = movie.trailerId;

        const slide = document.createElement('a');
        slide.className = 'slide';
        slide.href = `/#!/details?id=${itemId}`;
        slide.target = '_top';
        slide.rel = 'noreferrer';
        slide.setAttribute('tabindex', '0');

        slide.addEventListener('keydown', function(event) {
            if (event.keyCode === 13) {
                window.location.href = this.href;
            }
        });

        const backdrop = document.createElement('img');
        backdrop.className = 'backdrop';
        backdrop.src = `/Items/${itemId}/Images/Backdrop/0`;
        backdrop.alt = 'Backdrop';

        const logo = document.createElement('img');
        logo.className = 'logo';
        logo.src = `/Items/${itemId}/Images/Logo`;
        logo.alt = 'Logo';

        const featuredContent = document.createElement('div');
        featuredContent.className = 'featured-content';
        featuredContent.textContent = title;

        const plotElement = document.createElement('div');
        plotElement.className = 'plot';
        plotElement.textContent = plot;

        truncateText(plotElement, plotMaxLength);

        slide.appendChild(backdrop);
        slide.appendChild(logo);
        slide.appendChild(featuredContent);
        slide.appendChild(plotElement);

        if (UseAnyTrailers && hasTrailer) {
            slide.classList.add('with-wide-content');
            const wideScreenContent = document.createElement('div');
            wideScreenContent.className = 'wide-screen-content';
            
            const trailerIframe = document.createElement('iframe');
            trailerIframe.className = 'trailer-iframe';
            if (trailerId) {
                trailerIframe.src = `/web/index.html#!/details?id=${trailerId}&autoplay=true`;
            } else if (movie.trailerUrl) {
                trailerIframe.src = movie.trailerUrl;
            }
            trailerIframe.allowFullscreen = true;

            wideScreenContent.appendChild(trailerIframe);
            slide.appendChild(wideScreenContent);
        }

        return slide;
    }

    let currentSlide = 0;
    let slides;
    let shuffledIndexes;

    function initializeSlideshow() {
        slides = document.querySelectorAll(".slide");
        shuffledIndexes = shuffleArray(Array.from({ length: slides.length }, (_, i) => i));

        showSlide(currentSlide);
        setInterval(nextSlide, shuffleInterval);
        toggleWideScreenContent();
    }

    function showSlide(index) {
        for (var i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }
        slides[shuffledIndexes[index]].style.display = "block";
        destroyTrailer();
    }

    function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        showSlide(currentSlide);
    }

    function destroyTrailer() {
        const activeSlide = document.querySelector('.slide[style="display: block;"]');
        if (activeSlide) {
            const iframe = activeSlide.querySelector('.trailer-iframe');
            if (iframe) {
                iframe.src = '';
            }
        }
    }

    function checkContainerWidth() {
        const container = document.getElementById('slides-container');
        return container.offsetWidth;
    }

    let resizeTimeout;
    function debounce(func, wait) {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(func, wait);
    }

    function toggleWideScreenContent() {
        const containerWidth = checkContainerWidth();
        const wideScreenSlides = document.querySelectorAll('.slide.with-wide-content');
        const minWidth = 1200;

        wideScreenSlides.forEach(slide => {
            const wideScreenContent = slide.querySelector('.wide-screen-content');
            if (containerWidth >= minWidth) {
                wideScreenContent.style.display = 'block';
                slide.classList.add('wide-content-active');
            } else {
                wideScreenContent.style.display = 'none';
                slide.classList.remove('wide-content-active');
            }
        });
    }

    function checkBackdropAndTrailer(movie) {
        return Promise.all([
            fetch(`/Items/${movie.Id}/Images/Backdrop/0`, {
                method: 'HEAD',
                headers: {
                    'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"`
                }
            }),
            fetch(`/Users/${userId}/Items/${movie.Id}`, {
                headers: {
                    'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"`
                }
            }).then(response => response.json())
        ])
        .then(([backdropResponse, movieDetails]) => {
            if (backdropResponse.ok) {
                if (movie.ImageTags && movie.ImageTags.Logo) {
                    let hasTrailer = false;
                    let trailerId = null;
                    let trailerUrl = null;

                    if (movieDetails.LocalTrailerCount > 0) {
                        hasTrailer = true;
                        trailerId = movie.Id;
                    } 
                    else if (includeRemoteTrailers && movieDetails.RemoteTrailers && movieDetails.RemoteTrailers.length > 0) {
                        hasTrailer = true;
                        trailerUrl = movieDetails.RemoteTrailers[0].Url;
                    }

                    return { ...movie, hasTrailer, trailerId, trailerUrl };
                } else {
                    console.log(`Slide dismissed for lack of logo: ${movie.Name}`);
                    return null;
                }
            } else {
                console.log(`Slide dismissed for lack of backdrop: ${movie.Name}`);
                return null;
            }
        })
        .catch(error => {
            console.error(`Error checking backdrop and trailer for movie: ${movie.Name}`, error);
            return null;
        });
    }

    function fetchMovies() {
        const noCacheUrl = listFileName + '?' + new Date().getTime();

        fetch(noCacheUrl)
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    throw new Error('list.txt not found, fetching movies from server.');
                }
            })
            .then(text => {
                const lines = text.split('\n').filter(Boolean);
                const listTitle = lines.shift();
                if (listTitle) {
                    defaultTitle = listTitle;
                }

                const movieIds = lines.map(line => line.substring(0, 32));
                return Promise.all(movieIds.map(id => fetchMovieDetails(id)));
            })
            .then(movies => {
                Promise.all(movies.map(movie => checkBackdropAndTrailer(movie)))
                    .then(filteredMovies => {
                        filteredMovies.filter(movie => movie !== null).forEach(movie => createSlideForMovie(movie, defaultTitle));
                        initializeSlideshow();
                    });
            })
            .catch(error => {
                console.error(error);
                fetchMoviesFromServer();
            });
    }

    function fetchMovieDetails(movieId) {
        return fetch(`/Users/${userId}/Items/${movieId}`, {
            headers: {
                'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"`
            }
        })
            .then(response => response.json())
            .then(movie => {
                console.log("Slide Movie Title:", movie.Name);
                return movie;
            });
    }

    function fetchMoviesFromServer() {
        const randomStartIndex = Math.floor(Math.random() * randomStartMax);
        fetch(`/Users/${userId}/Items?IncludeItemTypes=Movie,Series&Recursive=true&Limit=${numberOfMovies}&StartIndex=${randomStartIndex}`, {
            headers: {
                'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"`
            }
        })
        .then(response => response.json())
        .then(data => {
            const movies = data.Items;
            const shuffledMovies = shuffleArray(movies);
            const selectedMovieIds = shuffledMovies.slice(0, numberOfMovies).map(movie => movie.Id);
            return Promise.all(selectedMovieIds.map(id => fetchMovieDetails(id)));
        })
        .then(movies => {
            Promise.all(movies.map(movie => checkBackdropAndTrailer(movie)))
                .then(filteredMovies => {
                    filteredMovies.filter(movie => movie !== null).forEach(movie => createSlideForMovie(movie, defaultTitle));
                    initializeSlideshow();
                });
        })
        .catch(error => console.error('Error fetching movies:', error));
    }

    fetchMovies();
    window.addEventListener('resize', () => debounce(toggleWideScreenContent, 250));

    // Handle visibility change to destroy trailer when page is hidden
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            destroyTrailer();
        }
    });
	
	// Intersection Observer to handle off-screen slides
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) {
                const iframe = entry.target.querySelector('.trailer-iframe');
                if (iframe) {
                    iframe.src = '';
                }
            }
        });
    }, { threshold: 0.1 }); // Trigger when 10% of the slide is visible

    function observeSlides() {
        document.querySelectorAll('.slide').forEach(slide => {
            observer.observe(slide);
        });
    }

    // Call observeSlides after slides are created
    function initializeSlideshow() {
        slides = document.querySelectorAll(".slide");
        shuffledIndexes = shuffleArray(Array.from({ length: slides.length }, (_, i) => i));

        showSlide(currentSlide);
        setInterval(nextSlide, shuffleInterval);
        toggleWideScreenContent();
        observeSlides(); // Add this line to start observing slides
    }

    fetchMovies();
    window.addEventListener('resize', () => debounce(toggleWideScreenContent, 250));

    // Handle visibility change to destroy trailer when page is hidden
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            destroyTrailer();
        }
    });
</script>
</body>
</html>