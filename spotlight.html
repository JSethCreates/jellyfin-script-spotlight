<!DOCTYPE html>
<html>
<head>
    <title>Jellyfin Spotlight</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        .slide { position: relative; width: 100vw; height: 100vh; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); cursor: pointer; outline: none; }
        .slide:focus { outline: 2px solid #fff; }
        .backdrop { position: absolute; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); object-fit: cover; object-position: center 20%; border-radius: 5px; z-index: 1; }
        .logo { position: absolute; top: 65%; left: 10px; transform: translateY(-50%); max-height: 50%; max-width: 30%; width: auto; z-index: 3; }
        .plot { position: absolute; bottom: 0; left: 0; right: 0; color: white; width: calc(100% - 300px); font-family: 'Noto Sans', sans-serif; font-size: 16px; background: linear-gradient(to top, rgba(0, 0, 0, 1) 20%, rgba(0, 0, 0, 0) 100%); padding: 10px; border-radius: 5px; z-index: 4; box-sizing: border-box; }
        .featured-content { position: absolute; top: 0; left: 0; width: calc(100% - 300px); height: 50px; background-color: transparent; font-family: 'Noto Sans', sans-serif; color: #D3D3D3; font-size: 22px; display: flex; align-items: center; justify-content: flex-start; z-index: 2; padding: 10px; box-sizing: border-box; }
        .video-container { position: absolute; right: 0; top: 0; width: 300px; height: 100%; z-index: 2; }
        .video-player { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="slides-container"></div>
    <script>
        let title = 'Spotlight II'; // Changeable title
        let movies2series3moviesandseries = 3; // 1 for movies, 2 for series, 3 for both
        const shuffleInterval = 10000;
        const plotMaxLength = 240;
        const userId = '0e0755005f074a59bc0108cc2c3e650b';
        const token = 'de81a85d55024d7b9fa7b11031de7539';
        let useTrailers = true; // New global variable
        let player = null; // YouTube player instance

        function createElem(tag, className, textContent, src, alt) {
            const elem = document.createElement(tag);
            if (className) elem.className = className;
            if (textContent) elem.textContent = textContent;
            if (src) elem.src = src;
            if (alt) elem.alt = alt;
            return elem;
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substr(0, maxLength) + '...' : text;
        }

        function createSlideElement(movie) {
            const container = document.getElementById('slides-container');
            const slide = createElem('div', 'slide');

            slide.appendChild(createElem('img', 'backdrop', null, `/Items/${movie.Id}/Images/Backdrop/0`, 'Backdrop'));
            slide.appendChild(createElem('img', 'logo', null, `/Items/${movie.Id}/Images/Logo`, 'Logo'));
            slide.appendChild(createElem('div', 'featured-content', title));

            const plotText = movie.Overview.length > plotMaxLength ? movie.Overview.substr(0, plotMaxLength) + '...' : movie.Overview;
            slide.appendChild(createElem('div', 'plot', plotText));

            if (useTrailers && movie.RemoteTrailers && movie.RemoteTrailers.length > 0) {
                const trailerUrl = movie.RemoteTrailers[0].Url; // Use the exact trailer URL from Jellyfin
                const videoId = new URL(trailerUrl).searchParams.get('v'); // Extract video ID from the URL

                console.log(`Trailer found: ${videoId}`);
                const videoContainer = createElem('div', 'video-container');
                const videoElement = createElem('div', 'video-player');
                videoContainer.appendChild(videoElement);
                slide.appendChild(videoContainer);

                // Create the YouTube player
                if (player) player.destroy(); // Clean up existing player
                player = new YT.Player(videoElement, {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    events: {
                        'onReady': onPlayerReady
                    }
                });
            } else if (useTrailers) {
                console.log('No trailer found.');
            }

            container.innerHTML = '';
            container.appendChild(slide);
        }

        function checkBackdropAndLogo(movie) {
            const itemId = movie.Id;

            fetch(`/Items/${itemId}/Images/Backdrop/0`, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        return fetch(`/Items/${itemId}/Images/Logo`, { method: 'HEAD' });
                    }
                    throw new Error('No backdrop');
                })
                .then(response => {
                    if (response.ok) {
                        createSlideElement(movie);
                    } else {
                        throw new Error('No logo');
                    }
                })
                .catch(() => fetchRandomMovie());
        }

        function fetchRandomMovie() {
            const itemTypes = movies2series3moviesandseries === 1 ? 'Movie' : (movies2series3moviesandseries === 2 ? 'Series' : 'Movie,Series');
            const headers = { 'Authorization': `MediaBrowser Client="Jellyfin Web", Device="YourDeviceName", DeviceId="YourDeviceId", Version="YourClientVersion", Token="${token}"` };

            fetch(`/Users/${userId}/Items?IncludeItemTypes=${itemTypes}&Recursive=true&Limit=1&Fields=Id,Overview,RemoteTrailers`, { headers })
                .then(response => response.json())
                .then(({ TotalRecordCount = 0 }) => {
                    const randomStartIndex = Math.floor(Math.random() * Math.min(TotalRecordCount, 2000));
                    return fetch(`/Users/${userId}/Items?IncludeItemTypes=${itemTypes}&Recursive=true&Limit=1&StartIndex=${randomStartIndex}&Fields=Id,Overview,RemoteTrailers`, { headers });
                })
                .then(response => response.json())
                .then(({ Items }) => Items.length > 0 ? checkBackdropAndLogo(Items[0]) : fetchRandomMovie())
                .catch(fetchRandomMovie);
        }

        function initializeSlideshow() {
            fetchRandomMovie();
            function scheduleNextFetch() {
                setTimeout(() => {
                    fetchRandomMovie();
                    scheduleNextFetch();
                }, shuffleInterval);
            }
            scheduleNextFetch();
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load YouTube IFrame API script
            const script = document.createElement('script');
            script.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(script);

            script.onload = () => {
                initializeSlideshow();
            };
        });
    </script>
</body>
</html>
